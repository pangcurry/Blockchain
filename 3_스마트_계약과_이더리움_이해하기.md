# 스마트 계약과 이더리움 이해하기

---







## 스마트 계약

---

### 스마트계약

- 현실의 권리 증명이나 이동 등을 포함한 계약을 자동으로 실행하는 구조를 스마트 계약이라고 한다.
- 비트코인의 경우 처음 만든 의도대로 암호화폐를 교환하는 용도로 사용한다.
- 하지만 비트코인의 기반이 된 블록체인 자체는 데이터 조작 방지 등의 특성을 다양하게 활용할 수 있다.

---

### 넓은 의미의 스마트 계약

- 자판기를 예로 들었을 때, 스마트 계약을 표현하면 다음과 같다.
  - 사용자가 자판기한테 **상품을 살 금액을 투입**하고, **사려는 상품 버튼을 누르면**
  - 자판기는 사용자한테 **상품을 제공**한다.
- 송금 과정을 위와같은 과정으로 빗대어 보면,
  - 앨리스는 100원이상의 금액이 있다.
  - 앨리스가 밥에게 100원을 송금하도록 요청했다.
  - 앞 두가지 조건을 만족하면 밥은 앨리스에서 100원을 받는다.
- 스마트 계약은 교환의 자동화를 구현하는 것이다.

---

### 블록체인의 스마트 계약

- 블록체인 안에서 동작하는 자동 계약 프로그램을 뜻한다.
- 블록체인의 스마트계약 장점
  - 상대를 신뢰하지 않아도 거래에 문제가 발생하지 않는다.
  - 중개자가 필요 없으므로 비용을 절감할 수 있다.

---

### 스마트 계약의 실제 예

- 법을 자동으로 이행하기
- 콘텐츠 수익을 자동으로 지급
- 보험금 자동 지급
- 카 렌트
- 자동 기부 시스템
- 고용 계약 시스템
- 전자 투표
- 기타 스마트 계약의 활용 분야

---







## 이더리움

---

### 이더리움

- 이더리움 재단에서 관리하는 **블록체인 플랫폼**이다.
- 비트코인으로 블록체인 네트워크에서 탈중앙화 애플리케이션을 실행할 수 있는 스크립트 언어를 제공한다.
- **이더**라는 화폐단위를 매개체로 애플리케이션을 개발하거나 이용할 수 있다.

---







## 비트코인과 이더리움의 차이

---

### 이더리움의 화폐 단위

- 이더리움에는 내부 화폐 단위로 '이더'가 있다.
- 암호화폐나 애플리케이션을 실행하는 연료로 사용한다. 이더리움에서는 이 비용을 가스라고 한다.

---

### 거래 수수료 '가스'

- 비트코인에서는 블록에 거래를 저장할 때 수수료를 지급해야한다.
- 이더리움 거래에서는 네트워크에 속한 노드에 연산을 시키는 것이므로 노드에 주는 연료가 필요하다.
- 거래를 실행할 때에는 **가스가격**과 **가스제한**을 설정한다.
- 둘을 곱하면 가스 상한이 된다.
- 무한 루프를 막기 위해서 가스 상한을 둔다.

---

### 계정 구조

- 이더리움은 다양한 분야에 사용할 수 있다. 그러므로 다양한 정보를 담을 수 있어야 한다.
- 계정 종류
  - 외부 계정 : 이더리움 사용자를 위한 계정이다. 주소와 연결해 잔액 정보를 갖는다.
  - 계약 계정 : 계약 증명이 있는 계정이다. 주소와 연결해 코드 정보 및 잔액 정보를 갖는다. 외부 계정에서 생성한다.
- 이더리움은 블록크기 제한을 두지 않으므로 블록의 크기가 무제한으로 커질 수 있다. 이를 막기 위해 계정 정보와 이더 잔액 정보는 상태트리에 저장한다.
- 상태트리는 블록 외부에 보관하고, 각 블록에는 상태 트리의 루트 노드값만 저장한다.
- 상태 트리에 저장하는 계정 정보
  - nonce : 계정에서 보낸 거래 횟수
  - balance : 계정의 잔액 정보를 wei로 나타낸다.
  - storageRoot : 계정과 연결된 저장소 트리의 루트 노드를 나타내는 256비트 해시값이다. 기본값은 비어 있다. 저장소 트리는 머클 패트리샤 트리 안 각 계정에 보관한 데이터의 관계를 나타내는 자료구조이다.
  - codeHash : EVM코드의 해시값이다. 계약 계정은 실행코드를 저장하고, 외부 계정은 공백 문자를 해시값으로 저장한다.

---

### 잔액 확인 방식의 차이

- 이더리움 계정 구조의 장점은 계정 정보를 별도의 자료구조로 분리해 빠른 검색이 가능하다.
- 단점은 계정 상태를 바꿀 때 선입선출 방식으로 작업을 실행해야 한다는 것이다.
- 이더리움은 비트코인보다 블록 생성 속도와 거래 속도를 빠르게 처리하는 구조를 만들어 단점을 보완한다.

---

### 블록 생성 속도의 차이

- 비트코인 블록 생성 속도는 10분에 1회이다.
- 이더리움의 블록 생성 속도는 약 15초로 비트코인의 40배이다.
- 거래 확정 과정도 비트코인보다 빠르다.
- 엉클 블록이 많아지면 네트워크에 참여하는 사람이 적다. 이더리움은 채굴자의 블록이 엉클 블록이 되더라도 보상을 주어 문제를 해결한다.
- 엉클 블록에도 보상이 있으면 채굴 속도가 빠른 사람이 보상을 독식할 수 없으므로 이더리움 생태계를 건전하게 유지할 수 있다.

---

### 블록 선택 방식의 차이

- 이더리움은 블록 높이가 같은 여러개 블록이 있을 때 각 체인에 묶인 블록들의 생성 난이도 전체를 더한 결과가 가장 높은 체인을 메인 체인으로 선택한다. 

---

### 작업증명 알고리즘의 차이

- 이더리움의 작업 증명 알고리즘은 이더해시를 사용한다.
- 이더리움의 작업증명 알고리즘의 특징
  - 블록의 헤더를 스캔해 블록을 대상으로 계산할 수 있는 값인 시드를 추출한다.
  - 시드에서 16MB 단위의 의사 랜덤 캐시를 만들고 GB 크기를 갖는 비순환 유향그래프 기반의 데이터셋을 만든다.
  - 1GB 이상의 데이터 셋에서 일부를 추출해 특정 조건이 될 때까지 임의의 값을 변경하면서 채굴하게 한다.
  - 데이터셋은 3만 블록 단위로 바뀌며 선형으로 커진다. 이를 이용해 일정 패턴으로 메모리 읽기 연산을 못하게 막는다. 데이터셋 저장공간도 일정하지 않도록 한다.

---

### 이더리움 가상 머신

- 이더리움은 애플리케이션을 실행하는 기반으로 튜링 완전한 가상 머신을 제공한다. 이를 이더리움 가상 머신이라고 한다.
- 스마트 계약은 코드 작성 후 EVM에서 실행할 수 있는 상태로 이더리움 블록체인에 배포한다.
- 이더리움은 처리속도, 데이터 크기, 스펙상의 제약 등과 관계없이 어떤 애플리케이션이든 실행할 수 있다는 것을 보장한다.

---

### 거래

- 이더리움의 거래는 비트코인처럼 암호화폐를 송금할 때 발생한다.
- 거래와 메시지는 계정에 있는 잔액, 상태트리, 저장소 트리를 변경한다. 데이터 변경 없이 읽기만 하는 'call' 이라는 처리도 있다.
- call에서는 가스를 발생하지 않는다.

