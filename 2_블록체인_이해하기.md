# 타임스탬프

---

- '2017-10-17 18:00:00' 와 같은 형식을 날짜와 시간을 표현한 것
- 거래 사실을 증명하는데 중요한 역할을 한다.

---

### 특성

- 모두가 같은 시간 흐름을 공유할 수 있다.
- 시간은 되돌릴 수 없기 때문에 변하지 않는 부분읻이다. 그러므로 사실을 증명할 수 있다.

---

### 문제점

- 만약 디지털 타임스탬프가 고장났을 때 거래 시간이 잘못되거나 없어질 수도 있다.

---

### 중앙 집중형 시스템

- 우리가 은행을 통해 거래를 할 때 보통 중앙집중형 시스템을 이용하여 거래를 한다. 은행의 중앙 서버에서 A와 B의 계좌 잔액, 타임스탬프 등을 관리한다.

---

### P2P 시스템

- 노드의 자원을 모아 사용 -> **관리자가 없는 시스템**

- 데이터 무결성을 유지하기 어려워 타임스탬프 기록의 신뢰성 보장 X

---

- 블록체인은 기존 P2P 시스템과 다른 타임스탬프 구조를 포함한 '탈중앙화 시스템'을 구축한 것이다.
- 가장 큰 특징 2가지
  - 분산 시스템
  - 누군가 시스템을 통제하지 않음

---

### 해시 체인 타임스탬프

- 타임스탬프를 기존의 절대적인 시간과 분리하여 상대적인 시간을이용한 것이다.
- 예를 들어 데이터 A가 있을 때 해시 알고리즘인 'SHA-256'을 이용해서 해시함수로 게산하면 일정한 값이 나온다. 이 값은 되돌릴 수 없으므로 안전한 데이터임을 논리적으로 보장하게 된다.
- A를 해시함수로 계산해서 h1가 나왔다고했을 때, h1을 다시한번 해시함수를 적용하면 h2가 나온다. 이런 방식으로 많아지면 해시 체인이 된다.
- 데이터 A를 해시함수로 계산하고 나서 h1이 되었다. 그리고 h1과 두번째 데이터 B를 합쳐서 다시 해시함수를 계산하여 h2가 나왔다. 이런식으로 상대적인 시간으로 타임스탬프를 정할 수 있다.

---

### P2P 시스템에서의 해시 체인 활용 문제점

- P2P 네트워크의 모든 노드가 항상 최신 타임스탬프를 확인할 수 있어야 한다.
- 어떤 노드에서 과거 데이터를 조작했음을 확인하거나 조작 자체를 막을 수 있어야 한다.

---

### 해시트리

- 어떤 데이터를 여러조각으로 나누어 조각 2개씩 묶어서 해시값을 계산한다.
- 만약 조각이 홀수 개라면 혼자인 값을 복제하여 묶어 해시값을 계산한다.

---

### 해시 체인과 해시트리

- 해시체인의 데이터가 들어갈 곳에 해시트리를 넣어서도 만들 수 있다.
- 만약 해시트리를적용하였다면 한 블록에 데이터를 동시에 담을 수 있게 된다.
- 만약 해시트리를 적용하였다면 블록을 생성할 때 새 데이터가 없어도 타임스탬프 숫자가 증가할 수 있다는 말이다.

---



# 작업증명 알고리즘

---

### 작업 증명 알고리즘

- 'P2P' 방식의 네트워크의 모든 노드가 항상 최신 타임스탬프를 확인할 수 있어야한다.
- 그래서 작업 증명 알고리즘을 통해 결점을 보완할 수 있다.

---

### 비트코인의 작업 증명 알고리즘

- 암호화 해시 함수의 특정 해시값 이하인 입력값을 찾는 것이라고 할 수 있다.
- 블록 안 다른 정보는 변하지 않으므로, 입력값의 차이는 논스가 결정하게 된다.
- **논스란?**
  - 최초0에서 시작해 조건을 만족하는 해시값을 찾을 때까지 1씩 증가하는 계산 횟수를 말한다.
- 논스를 증가시키면서 블록의 해시값(출력값)이 타깃 이하인 논스를 찾는 것이 작업 증명 알고리즘을 푸는 방법이다.
- 작업 증명 알고리즘을 잘 풀었다면 보상으로 새 블록을 생성하는데 이것을 '채굴'이라고 한다.
- 채굴하는 노드는 채굴자이다.
- 비트코인은 평균 10분에 1개 정도의 블록을 생성하도록 조정한다.
- 이것이 블록 간격이다.
- 정리
  1. 해시 트리와 해시 체인 타임스탬프 서버 구축
  2. 작업 증명 알고리즘으로 10분에 1회 '블록' 생성
  3. 1~2로 블록의 앞뒤 순서를 정의해 거래 내역의 안정성 보장
  4. 탈중앙화 P2P 네트워크에서 블록을 채굴한 보상으로 받는 화폐를 소유하거나 거래

---

### 블록 타임스탬프 & 네트워크 조정 시간

- 블록에 설정하는 유닉스 타임스탬프이다.
- 블록의 해시값 계산이 끝났을 때 함께 저장한다.

---

### 블록 타임스탬프 설정

- '앞에 있는 11개 블록 타임스탬프값의 중앙값'보다 커야한다.
- 네트워크 조정 시간은 P2P 네트워크에서 자신과 연결된 모든 노드가 반환할 블록 타임스탬프의 중앙값이다.
- 네트워크 조정 시간보다 2시간 이상 지난 시각은 블록 타임스탬프값으로 설정할 수 없다.

---

- 블록 타임스탬프는 실제 시간과 1~2시간 오차가 발생할 수 있다.
- 앞,뒤 블록 정도는 순서가 바뀔 수 있다. ( 이정도 문제는 감안하기로 합의를 했다고 한다. )

---

### 나카모토 합의

- 블록  타임스탬프의 오차 때문에 최신 블록 정보가 도달하기 전 새 블록을 생성할 수도 있다.(블록 높이가 같은 블록2개가 있는 상태)
- 높이를 '나카모토 합의' 라고 한다. 
- **블록의 특성**
  1. 앞에있는 블록은 뒤에 연결한 블록이 선택받지 못하더라도 해당 블록에 있는 정보를 저장해둔다. 선택받지 못한 블록과 같은 블록 높이를 갖는 새 블록이 생성되면 선택받지 못한 블록에 있는 데이터를 블록에 저장하지 않은 데이터로 취급해 새 블록에 저장하려고 한다.
  2. 블록 높이가 같은 2개의 블록에 서로 다른 정보가 있으면, 작업 증명 알고리즘의 난이도가 더 높은 블록을 선택해 전달한다. 
  3. 블록 높이가 다른 2개의 블록이라면, 긴 체인의 정보를 선택해 전달한다.
  4. 2와 3은 최소 3~5개의 블록을 추가해야만 유효하다.

---





# UTXO

---

- 비트코인의 블록체인에서 구현한 송금 시스템의 자료구조

---

### 계정 기반 잔액 저장 방식

- 계정을 기반으로 잔액 저장하는 자료구조를 구성하기 위해서는 여러계정의 잔액을 동시에 업데이트하는 거래 기능을 구현해야 한다.
- A가 B에게 50원을 보낸다고 했을 때, 만약 송금 시스템의 장애로, A 잔액에만 50을 빼면 50원이 없어지게 된다. 

---

### 거래 기반 방식

- 실제 화폐 거래와 비슷하게 화폐를 50원 단위로 나누어서 두사람의 계좌의 총 잔액만큼 발행한다. 
- 화폐번호 1~6번을 설정을 하고 1,2는 A, 나머지는 B 로 소유자를 지정하고, 송금할 때에는 A가 소유자인 화폐번호 중 하나를 골라 소유자를 밥으로만 바꾸면 된다.
- 50원이 없어질 일이 없다.
- 잔액을 확인할 때 화폐 총 잔액을 계산해서 일정 단위로 나누어야 한다는 번거로움이 있다.

